// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

///////////////////////////////////////////////////////////
// USER & SESSION
///////////////////////////////////////////////////////////

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  documents     Document[]

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Account {
  id                 String   @id @default(cuid())
  userId             String
  accountId          String
  providerId         String
  accessToken        String?
  refreshToken       String?
  accessTokenExpiresAt    DateTime?
  refreshTokenExpiresAt   DateTime?
  scope              String?
  idToken            String?
  password           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("accounts")
}

model Verification {
  id          String   @id @default(cuid())
  identifier  String
  value       String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([identifier])
  @@map("verifications")
}

///////////////////////////////////////////////////////////
// DOCUMENT WORKFLOW
///////////////////////////////////////////////////////////

model Document {
  id            String             @id @default(uuid()) @db.Uuid
  ownerId       String             @map("owner_id")
  title         String
  description   String?            @map("description")
  documentType  String?            @map("document_type")
  currentStep   Int                @map("current_step")
  subStep       Int?               @map("sub_step") // 1 or 2 for step 3 sub-steps
  status        DocumentStatus
  
  // Document source tracking
  sourceType    String?            @map("source_type") // 'upload' | 'blank'
  pdfPath       String?            @map("pdf_path") // Supabase Storage path
  
  // Content tracking for create document scenario
  currentContentId String?         @unique @map("current_content_id") @db.Uuid // Reference to current content
  
  // PDF tracking for signing
  currentPdfId  String?            @unique @map("current_pdf_id") @db.Uuid // Reference to current PDF
  
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  // Relations
  owner         User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  contents      DocumentContent[]
  drafts        DocumentDraft[]
  signatures    Signature[]
  currentContent DocumentContent?  @relation("DocumentCurrentContent", fields: [currentContentId], references: [id])
  currentPdf    DocumentPdf?       @relation("DocumentCurrentPdf", fields: [currentPdfId], references: [id])
  pdfs          DocumentPdf[]      @relation("DocumentPdfs")

  @@index([ownerId])
  @@map("documents")
}

model DocumentContent {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid @map("document_id")

  // Content data - CHANGED: Now storing HTML instead of JSON
  htmlContent String   @map("html_content") // Raw HTML content (required)

  // Version tracking
  version     Int      @default(1)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  currentForDocument Document? @relation("DocumentCurrentContent")

  @@index([documentId])
  @@index([documentId, version])
  @@map("document_contents")
}

///////////////////////////////////////////////////////////
// PDF DOCUMENTS
///////////////////////////////////////////////////////////

model DocumentPdf {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid @map("document_id")
  
  // PDF metadata
  pdfPath     String   @map("pdf_path") // Supabase Storage path
  fileName    String   @map("file_name")
  fileSize    Int      @map("file_size")
  pageCount   Int?     @map("page_count") // Number of pages in PDF
  
  // Status tracking
  status      String   @default("ready") // 'ready' | 'signed'
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  document    Document @relation("DocumentPdfs", fields: [documentId], references: [id], onDelete: Cascade)
  signatures  Signature[]
  currentForDocument Document? @relation("DocumentCurrentPdf")
  
  @@index([documentId])
  @@map("document_pdfs")
}

///////////////////////////////////////////////////////////
// PDF & DRAFTS
///////////////////////////////////////////////////////////

model DocumentDraft {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid @map("document_id")
  pdfPath     String   @map("pdf_path")
  version     Int
  templateId  String?  @map("template_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@map("document_drafts")
}

///////////////////////////////////////////////////////////
// SIGNATURES
///////////////////////////////////////////////////////////

model Signature {
  id              String   @id @default(uuid()) @db.Uuid
  documentId      String   @db.Uuid @map("document_id")
  documentPdfId   String?  @db.Uuid @map("document_pdf_id") // Reference to PDF
  
  imagePath       String   @map("image_path")
  pageNumber      Int      @map("page_number")
  
  // PDF coordinates (for embedding in PDF)
  posX            Float    @map("pos_x")
  posY            Float    @map("pos_y")
  
  // Canvas coordinates (for display)
  canvasPosX      Float?   @map("canvas_pos_x")
  canvasPosY      Float?   @map("canvas_pos_y")
  
  width           Float
  height          Float
  signerName      String   @map("signer_name")
  signerPosition  String?  @map("signer_position")
  organization    String?
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentPdf     DocumentPdf? @relation(fields: [documentPdfId], references: [id])

  @@index([documentId])
  @@index([documentPdfId])
  @@map("signatures")
}

///////////////////////////////////////////////////////////
// ENUMS
///////////////////////////////////////////////////////////

enum DocumentStatus {
  draft
  signed
}
