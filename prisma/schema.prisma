// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

///////////////////////////////////////////////////////////
// USER & SESSION
///////////////////////////////////////////////////////////

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  documents     Document[]

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Account {
  id                 String   @id @default(cuid())
  userId             String
  accountId          String
  providerId         String
  accessToken        String?
  refreshToken       String?
  accessTokenExpiresAt    DateTime?
  refreshTokenExpiresAt   DateTime?
  scope              String?
  idToken            String?
  password           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique(providerId)
  @@index([userId])
  @@map("accounts")
}

model Verification {
  id          String   @id @default(cuid())
  identifier  String
  value       String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([identifier])
  @@map("verifications")
}

///////////////////////////////////////////////////////////
// DOCUMENT WORKFLOW
///////////////////////////////////////////////////////////

model Document {
  id           String             @id @default(uuid()) @db.Uuid
  ownerId      String             @map("owner_id")
  title        String
  currentStep  Int                @map("current_step")
  status       DocumentStatus
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  // Relations
  owner        User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  contents     DocumentContent[]
  drafts       DocumentDraft[]
  signatures   Signature[]

  @@index([ownerId])
  @@map("documents")
}

model DocumentContent {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid @map("document_id")
  contentJson Json     @map("content_json")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("document_contents")
}

///////////////////////////////////////////////////////////
// PDF & DRAFTS
///////////////////////////////////////////////////////////

model DocumentDraft {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid @map("document_id")
  pdfPath     String   @map("pdf_path")
  version     Int
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@map("document_drafts")
}

///////////////////////////////////////////////////////////
// SIGNATURES
///////////////////////////////////////////////////////////

model Signature {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @db.Uuid @map("document_id")
  imagePath   String   @map("image_path")
  pageNumber  Int      @map("page_number")
  posX        Float    @map("pos_x")
  posY        Float    @map("pos_y")
  width       Float
  height      Float
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("signatures")
}

///////////////////////////////////////////////////////////
// ENUMS
///////////////////////////////////////////////////////////

enum DocumentStatus {
  draft
  signed
}
